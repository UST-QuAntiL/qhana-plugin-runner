{% extends "simple_template.html" %}

{% block head %}
{{ super() }}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
<style>
    body {
        margin: 0px;
    }

    .content {
        width: 100%;
        height: calc(100vh - 1rem);
        padding-block: 0.5rem;
        position: relative;
        background-color: white;
        color: black;
    }

    .workflow-list {
        max-height: 50vh;
        overflow-y: auto;
        scrollbar-gutter: stable;
        margin-block-end: 1rem;
    }

    .workflow-item {
        width: 100%;
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: center;
        justify-content: space-between;
    }

    .workflow-item:not(:nth-child(1)) {
        border-top: 1px solid var(--border-color, gray);
    }

    .workflow-title {
        font-weight: 600;
        font-size: 120%;
        margin-block: 0.1em;
    }

    .workflow-subtitle {
        margin-block: 0.1em;
    }

</style>

<script>
    // register a beforeunload listener first to prevent unloading message
    window.addEventListener("beforeunload", (event) => {event.stopImmediatePropagation();}, {capture: true});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.9.6/ace.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.9.6/mode-xml.min.js"></script>
<script src="{{wf_editor_js}}"></script>

{% endblock head %}

{% block content %}
<div class="content" id="modeler-container">
    <quantum-workflow-modeler id="main-wf-modeler"></quantum-workflow-modeler>

    <dialog class="card mat-mdc-card color-scheme-card" id="openWF" closedby="any" autofocus>
        <h2>Open Workflow</h2>
        <form method="dialog" clas="qhana-form">
            <div class="qhana-form-field">
                <label class="qhana-form-label" for="openWFinput">Open Workflow from local filesystem:</label>
                <div class="qhana-input-wrapper">
                    <input class="qhana-form-input" type="file" name="workflow" id="openWFinput" accept="bpmn" required>
                    <button class="qhana-form-submit" type="submit" value="openLocal">Open selected workflow</button>
                </div>
            </div>
        </form>
        <h3>Load Saved Workflow</h3>
        <form method="dialog" id="openExisting" clas="qhana-form">
            <div class="workflow-list">
            </div>
            <button class="cancel-dialog qhana-form-submit" type="submit" value="cancel">Close dialog</button>
        </form>
    </dialog>

    <dialog class="card mat-mdc-card color-scheme-card" id="deployWF" closedby="any">
        <h2>Deploy Workflow</h2>
        <form method="dialog" clas="qhana-form">
            <button class="qhana-form-submit" type="submit" value="cancel" autofocus>Cancel</button>
            <button class="qhana-form-submit" type="submit" value="deployPlugin">Deploy as Plugin</button>
            <button class="qhana-form-submit" type="submit" value="deployWorkflow">Deploy as Workflow</button>
        </form>
    </dialog>
</div>
<div id="editor_wrap" style="display: none">
    <div id="editor_dragbar"></div>
    <div id="editor"></div>
</div>
{% endblock content %}

{% block script %}
{{ super() }}

<script>
    window.ENABLE_PATTERN_PLUGIN = true;

    const state = window._qhana_microfrontend_state;
    if (state) {
        state.targetHeight = "full";
    }

    const editor = ace.edit("editor");
    editor.getSession().setMode("ace/mode/xml");
    editor.setTheme("ace/theme/textmate");

    const modeler = document.getElementById("main-wf-modeler");

    function getRootElement() {
        return temp1.bpmnjsModeler.get("elementRegistry").find(e => e.type==="bpmn:Process" && e.parent == null);
         //.businessObject.versionTag = "6"
         //.businessObject.name = "6"
         //.businessObject.id = "6"
         // const modeling = temp1.bpmnjsModeler.get("modeling")
         // modeling.updateProperties(rootProcess, {versionTag: "7"})
    }

    function getCurrentBpmn() {
        // workaround for inconsistent xml attribute
        const xmlObject = modeler.bpmnjsModeler.xml;
        if (xmlObject.xml != null) {
            // if attribute contained an object wrapping the actual xml content
            return xmlObject.xml;
        }
        return xmlObject;
    }

    /**
     * Handle file open request events.
     *
     * @param {CustomEvent} event
     */
    function onFileOpenRequest(event) {
        event.preventDefault();
        const dialogElement = document.querySelector("dialog#openWF");
        const url = "{{wf_list_url}}";
        fetch(url).then(response => response.json()).then(result => {
            const container = document.querySelector("form#openExisting .workflow-list");
            
            const newChildren = result.map(workflow => {
                const outer = document.createElement("div");
                outer.classList.add("workflow-item")
                const inner = document.createElement("div");
                const title = document.createElement("p");
                title.classList.add("workflow-title");
                title.textContent = `${workflow["name"]} – ${workflow["id"]}@${workflow["version"]}`;
                const subtitle = document.createElement("p");
                subtitle.classList.add("workflow-subtitle");
                subtitle.textContent = workflow["date"] + (workflow["autosave"] ? " – autosave" : "");
                const button = document.createElement("button");
                button.setAttribute("value", `load:${workflow["workflowId"]}`);
                button.setAttribute("type", "submit");
                button.classList.add("qhana-form-submit");
                button.textContent = `Load ${workflow["name"]}`;
                inner.appendChild(title);
                inner.appendChild(subtitle);
                outer.appendChild(inner);
                outer.appendChild(button);
                return outer;
            });

            container.replaceChildren(...newChildren);
        });
        dialogElement.showModal();
    }

    function onOpenDialogClosed(event) {
        const localWFInput = event.target.querySelector("input#openWFinput");
        if (event.target.returnValue === "openLocal") {
            if (localWFInput.files.length === 1) {
                modeler.loadWorkflowFile(localWFInput.files[0]);
            }
        }
        localWFInput.value = "";
        if (event.target.returnValue === "cancel") {
            return;
        }
        if (event.target.returnValue.startsWith("load:")) {
            const workflow_id = event.target.returnValue.substring(5);
            const base_url = "{{wf_list_url}}";
            const url = `${base_url}${workflow_id}/`
            fetch(url).then(response => {
                if (response.status === 200) {
                    return response.text();
                } else {
                    throw Error("Could not load BPMN!");
                }
            }).then(bpmn => modeler.loadWorkflowDiagram(bpmn));
        }
    }

    /**
     * Handle before save events.
     *
     * @param {CustomEvent} event
     */
    function onBeforeSave(event) {
        event.preventDefault();
        const isAutoSave = event.detail.autoSave;
        const bpmn = event.detail.workflow;
        
        const url = "{{wf_list_url}}";
        fetch(
            `${url}?autosave=${isAutoSave ? 'true' : 'false'}`,
            {method: "post", keepalive: true, body: bpmn, headers: {content_type: "application/bpmn+xml"}}
        );
    }

    /**
     * Handle before deploy events.
     *
     * @param {CustomEvent} event
     */
    function onBeforeDeploy(event) {
        event.preventDefault();
        const dialogElement = document.querySelector("dialog#deployWF");
        dialogElement.showModal();
    }

    function onDeployDialogClosed(event) {
        const dialogResult = event.target.returnValue;
        if (dialogResult === "cancel") {
            return;
        }
        const url = "{{wf_list_url}}";
        const bpmn = getCurrentBpmn();
        console.log(bpmn)
        if (dialogResult === "deployWorkflow") {
            fetch(
                `${url}?autosave=false&deploy=workflow`,
                {method: "post", keepalive: true, body: bpmn, headers: {content_type: "application/bpmn+xml"}}
            );
        }
        if (dialogResult === "deployPlugin") {
            fetch(
                `${url}?autosave=false&deploy=plugin`,
                {method: "post", keepalive: true, body: bpmn, headers: {content_type: "application/bpmn+xml"}}
            );
        }
    }

    /**
     * Handle transform events.
     *
     * @param {CustomEvent} event
     */
    function onTransform(event) {
        event.preventDefault();

        // save old pre transformation workflow as autosave snapshot
        const oldWorkflow = getCurrentBpmn();
        const url = "{{wf_list_url}}";
        fetch(
            `${url}?autosave=true`, 
            {method: "post", keepalive: true, body: oldWorkflow, headers: {content_type: "application/bpmn+xml"}}
        );

        const newWorkflow = event.detail.workflow;
        const parsedWorkflow = (new DOMParser()).parseFromString(newWorkflow, "application/xml");
        const processElement = parsedWorkflow.getElementsByTagNameNS("http://www.omg.org/spec/BPMN/20100524/MODEL", "process")[0];

        // rename workflow to include a "transformed" prefix
        processElement.setAttribute("name", processElement.getAttribute("name") + "_transformed");
        const renamedWorkflow = (new XMLSerializer()).serializeToString(parsedWorkflow);

        modeler.loadWorkflowDiagram(renamedWorkflow);        
    }

    modeler.addEventListener("quantum-workflow-request-open", onFileOpenRequest);
    modeler.addEventListener("quantum-workflow-before-save", onBeforeSave);
    modeler.addEventListener("quantum-workflow-before-deploy", onBeforeDeploy);
    modeler.addEventListener("quantum-workflow-transformed", onTransform);

    document.querySelector("dialog#openWF").addEventListener("close", onOpenDialogClosed)
    document.querySelector("dialog#deployWF").addEventListener("close", onDeployDialogClosed)

    modeler.pluginConfigs = [
        {
            name: "dataflow",
            config: {
                configurationsEndpoint: "{{DATAFLOW_ENDPOINT}}"
            }
        },
        {
            name: "quantme",
            config: {
                transformationFrameworkEndpoint: "{{TRANSFORMATION_FRAMEWORK_ENDPOINT}}",
                nisqAnalyzerEndpoint: "{{NISQ_ANALYZER_ENDPOINT}}",
                nisqAnalyzerUiEndpoint: "{{NISQ_ANALYZER_UI_ENDPOINT}}",
                qprovEndpoint: "{{QPROV_ENDPOINT}}",
                scriptSplitterEndpoint: "{{SCRIPT_SPLITTER_ENDPOINT}}",
                scriptSplitterThreshold: "{{SCRIPT_SPLITTER_THRESHOLD}}",
                qiskitRuntimeHandlerEndpoint: "{{QISKIT_RUNTIME_HANDLER_ENDPOINT}}",
                awsRuntimeHandlerEndpoint: "{{AWS_RUNTIME_HANDLER_ENDPOINT}}"
            }
        },
        // {
        //     name: "planqk"
        // },
        {
            name: "qhana",
            config: {
                qhanaPluginRegistryURL: "{{PLUGIN_REGISTRY_URL}}"
            }
        },
        {
            name: "pattern",
            config: {
                patternAtlasEndpoint: "{{PATTERN_ATLAS_ENDPOINT}}",
                patternAtlasUIEndpoint: "{{PATTERN_ATLAS_UI_ENDPOINT}}",
                qcAtlasEndpoint: "{{QC_ATLAS_ENDPOINT}}"
            }
        },
        {
            name: "opentosca", 
            config: {
                opentoscaEndpoint: "{{OPENTOSCA_ENDPOINT}}",
                wineryEndpoint: "{{WINERY_ENDPOINT}}"
            }
        },
        {
            name: "editor",
            config: {
                camundaEndpoint: "{{CAMUNDA_ENDPOINT}}",
                fileName: "{{FILE_NAME}}",
                transformedWorkflowHandler: "{{TRANSFORMED_WORKFLOW_HANDLER}}",
                autoSaveFileOption: "{{AUTO_SAVE_FILE_OPTION}}",
                fileFormat: "{{FILE_FORMAT}}",
                autoSaveIntervalSize: "{{AUTO_SAVE_INTERVAL_SIZE}}",
                githubToken: "{{GITHUB_TOKEN}}",
                githubRepositoryName: "{{GITHUB_REPOSITORY_NAME}}",
                githubUsername: "{{GITHUB_USERNAME}}",
                githubRepositoryPath: "{{GITHUB_REPOSITORY_PATH}}",
                uploadGithubRepositoryName: "{{UPLOAD_GITHUB_REPOSITORY_NAME}}",
                uploadGithubRepositoryOwner: "{{UPLOAD_GITHUB_REPOSITORY_OWNER}}",
                uploadGithubRepositoryPath: "{{UPLOAD_GITHUB_REPOSITORY_PATH}}",
                uploadFileName: "{{UPLOAD_FILE_NAME}}",
                uploadBranchName: "{{UPLOAD_BRANCH_NAME}}",
            }
        }
    ];

    console.log("WF Editor: ", modeler);
</script>

{% endblock script %}
