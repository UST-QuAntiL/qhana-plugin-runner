{% extends "simple_template.html" %}

{% block head %}
{{ super() }}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
<style>
    body {
        margin: 0px;
    }

    .content {
        width: 100%;
        height: calc(100vh - 1rem);
        padding-block: 0.5rem;
        position: relative;
        background-color: white;
        color: black;
    }
</style>

<script>
    // register a beforeunload listener first to prevent unloading message
    window.addEventListener("beforeunload", (event) => {event.stopImmediatePropagation();}, {capture: true});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.9.6/ace.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.9.6/mode-xml.min.js"></script>
<script src="{{wf_editor_js}}"></script>

{% endblock head %}

{% block content %}
<div class="content" id="modeler-container">
    <quantum-workflow-modeler id="main-wf-modeler"></quantum-workflow-modeler>
</div>
<div id="editor_wrap" style="display: none">
    <div id="editor_dragbar"></div>
    <div id="editor"></div>
</div>
{% endblock content %}

{% block script %}
{{ super() }}

<script>
    window.ENABLE_PATTERN_PLUGIN = true;

    const state = window._qhana_microfrontend_state;
    if (state) {
        state.targetHeight = "full";
    }

    const editor = ace.edit("editor");
    editor.getSession().setMode("ace/mode/xml");
    editor.setTheme("ace/theme/textmate");

    const modeler = document.getElementById("main-wf-modeler");
    
    fetch('http://localhost:5005/plugins')
        .then(response => response.json())
        .then(data => {
            modeler.qhanaPlugins = data;
            console.log("Fetched QHAna Plugins:", modeler.qhanaPlugins);
        })
        .catch(error => {
            console.error("Error fetching QHAna plugins:", error);
        });

    modeler.pluginConfigs = [
        {
            name: "dataflow",
            config: {
                configurationsEndpoint: "{{DATAFLOW_ENDPOINT}}"
            }
        },
        {
            name: "quantme",
            config: {
                transformationFrameworkEndpoint: "{{TRANSFORMATION_FRAMEWORK_ENDPOINT}}",
                nisqAnalyzerEndpoint: "{{NISQ_ANALYZER_ENDPOINT}}",
                nisqAnalyzerUiEndpoint: "{{NISQ_ANALYZER_UI_ENDPOINT}}",
                qprovEndpoint: "{{QPROV_ENDPOINT}}",
                scriptSplitterEndpoint: "{{SCRIPT_SPLITTER_ENDPOINT}}",
                scriptSplitterThreshold: "{{SCRIPT_SPLITTER_THRESHOLD}}",
                qiskitRuntimeHandlerEndpoint: "{{QISKIT_RUNTIME_HANDLER_ENDPOINT}}",
                awsRuntimeHandlerEndpoint: "{{AWS_RUNTIME_HANDLER_ENDPOINT}}"
            }
        },
        // {
        //     name: "planqk"
        // },
        {
            name: "qhana",
            config: {
                qhanaPluginRegistryURL: "{{PLUGIN_REGISTRY_URL}}"
            }
        },
        {
            name: "pattern",
            config: {
                patternAtlasEndpoint: "{{PATTERN_ATLAS_ENDPOINT}}",
                patternAtlasUIEndpoint: "{{PATTERN_ATLAS_UI_ENDPOINT}}",
                qcAtlasEndpoint: "{{QC_ATLAS_ENDPOINT}}"
            }
        },
        {
            name: "opentosca", 
            config: {
                opentoscaEndpoint: "{{OPENTOSCA_ENDPOINT}}",
                wineryEndpoint: "{{WINERY_ENDPOINT}}"
            }
        },
        {
            name: "editor",
            config: {
                camundaEndpoint: "{{CAMUNDA_ENDPOINT}}",
                fileName: "{{FILE_NAME}}",
                transformedWorkflowHandler: "{{TRANSFORMED_WORKFLOW_HANDLER}}",
                autoSaveFileOption: "{{AUTO_SAVE_FILE_OPTION}}",
                fileFormat: "{{FILE_FORMAT}}",
                autoSaveIntervalSize: "{{AUTO_SAVE_INTERVAL_SIZE}}",
                githubToken: "{{GITHUB_TOKEN}}",
                githubRepositoryName: "{{GITHUB_REPOSITORY_NAME}}",
                githubUsername: "{{GITHUB_USERNAME}}",
                githubRepositoryPath: "{{GITHUB_REPOSITORY_PATH}}",
                uploadGithubRepositoryName: "{{UPLOAD_GITHUB_REPOSITORY_NAME}}",
                uploadGithubRepositoryOwner: "{{UPLOAD_GITHUB_REPOSITORY_OWNER}}",
                uploadGithubRepositoryPath: "{{UPLOAD_GITHUB_REPOSITORY_PATH}}",
                uploadFileName: "{{UPLOAD_FILE_NAME}}",
                uploadBranchName: "{{UPLOAD_BRANCH_NAME}}",
            }
        }
    ];

    console.log("WF Editor: ", modeler);
</script>

{% endblock script %}
