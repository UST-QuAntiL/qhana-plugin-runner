{% extends "simple_template.html" %}

{% block head %}
{{ super() }}
<datalist id="id_attribute_list"></datalist>
{% endblock head %}

{% block content %}
<div id="pandas_html" style='height: 200px; overflow: auto; width: fit-content'>Placeholder</div>
<div class="qhana-microfrontend">
    {% block help %}
    {% if help_text or example_values %}
    <details class="qhana-help">
        <summary>Help</summary>
        {% if help_text %}
        {% autoescape false %}
        {{help_text | markdown}}
        {% endautoescape %}
        {% else %}
        <br>
        {% endif %}
        {% if example_values %}
        <a href="{{example_values}}">Fill in example values.</a>
        {% endif %}
    </details>
    {% endif %}
    {% endblock help %}
    {% call forms.render_form(target="microfrontend") %}
    {{ forms.render_fields(schema, values=values, errors=errors) }}
    <div class="qhana-form-buttons">
        <!--            {{ forms.submit("validate", target=validate)}}-->
        {{ forms.submit("validate", target="microfrontend")}}
        {{ forms.submit("submit", action=process)}}
        <button type="button" id="test_button">
            test_button
        </button>
        {% if not errors and valid %}
        <span class="qhana-input-description"> Validation successful!</span>
        <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
             x="0px" y="0px" width="25" height="15" viewBox="0 0 122.881 89.842"
             enable-background="new 0 0 122.881 89.842">
            <g>
                <path fill="rgb(0, 247, 0)"
                      d="M1.232,55.541c-1.533-1.388-1.652-3.756-0.265-5.289c1.388-1.534,3.756-1.652,5.29-0.265l34.053,30.878l76.099-79.699 c1.429-1.501,3.804-1.561,5.305-0.132c1.502,1.428,1.561,3.803,0.133,5.305L43.223,88.683l-0.005-0.005 c-1.396,1.468-3.716,1.563-5.227,0.196L1.232,55.541L1.232,55.541z"/>
            </g>
        </svg>
        {% endif %}
    </div>
    {% endcall %}
</div>
{% endblock content %}

{% block script %}
<script>
    const font_size = 13. + 1. / 3.;

    let check_box_list;
    let table_select;

    const custom_query_value = document.getElementById("custom_query");
    const save_table_value = document.getElementById("save_table");
    const columns_list_value = document.getElementById("columns_list");
    const table_name_value = document.getElementById("table_name");
    const attribute_to_id_value = document.getElementById("id_attribute")
    const id_attribute_list_value = document.getElementById("id_attribute_list");
    const tables_and_columns = JSON.parse('{{ additional_info }}');


    const attribute_to_id_vis = attribute_to_id_value.parentNode.parentNode;
    const db_query_vis = document.getElementById("db_query").parentNode.parentNode;
    const columns_list_vis = columns_list_value.parentNode.parentNode;
    const table_name_vis = table_name_value.parentNode.parentNode;


    function change_custom_query() {
        db_query_vis.style.display = "none";
        columns_list_vis.style.display = "block";
        table_name_vis.style.display = "block";
        if (custom_query_value.checked === true) {
            db_query_vis.style.display = "block";
            columns_list_vis.style.display = "none";
            table_name_vis.style.display = "none";
        }
    }


    function create_checkbox(name, check_status = false) {
        let label_element = document.createElement("label");
        label_element.setAttribute("for", name);
        label_element.style.cssText = "display: block; color: WindowText; background-color: Window; margin: 0; padding: 0; width: 100%;";

        let input_element = document.createElement("input");
        input_element.setAttribute("type", "checkbox");
        input_element.setAttribute("name", name);
        input_element.setAttribute("id", name + "_box");
        input_element.checked = check_status;
        // input_element.addEventListener("change", append_value_to_str_list, false);
        label_element.appendChild(input_element);

        let text = document.createTextNode(name);
        label_element.appendChild(text);


        label_element.style.font = font_size + "px DejaVu,Sans";

        return label_element;
    }


    function update_check_all_box_indeterminate(event) {
        let check_box = event.target;
        let check_all_box = document.getElementById("select all_box");

        if (!check_all_box.indeterminate) {
            check_all_box.indeterminate = (check_box.checked !== check_all_box.checked);
        }
    }


    function create_checkbox_for_list(name, check_status = false) {
        let list_element = document.createElement("li");
        list_element.style.cssText = "margin: 0; padding: 0;";
        let check_box = create_checkbox(name, check_status);
        check_box.children[0].addEventListener("change", update_check_all_box_indeterminate);
        list_element.appendChild(check_box);

        return list_element;
    }


    function set_all_check_box_list(checked_values) {
        let check_box_list = document.getElementById("check_box_list");
        //iterate through li elements
        for (let i = 0; i < check_box_list.children.length; i++) {
            // Set checked status
            check_box_list.children[i].children[0].children[0].checked = checked_values;
        }
    }


    function check_all_box_change(event) {
        set_all_check_box_list(event.target.checked);
    }


    function init_check_all_box() {
        if (document.getElementById("select all_id") === null) {
            let check_all_box = create_checkbox("select all");
            // check_all_box.children[0].indeterminate = true;
            check_all_box.children[0].addEventListener("change", check_all_box_change);
            check_all_box.outerHTML = "<br />";

            columns_list_value.parentNode.appendChild(check_all_box);
        }
    }

    function create_check_box_list() {
        if (document.getElementById("check_box_list") !== null) {
            document.getElementById("check_box_list").remove();
        }
        check_box_list = document.createElement("ul");
        check_box_list.id = "check_box_list";
        check_box_list.className = "qhana-form-input";
        check_box_list.style.cssText = "height: 100px; overflow: auto; max-width: 25em; border: 1px solid #8f8f9d; list-style-type: none; margin: 0; padding: 0.3em; flex-grow: 1; overflow-x: hidden;";
        // dummy_field_value.style.cssText = "height: 100px; overflow: auto; max-width: 25em; border: 1px solid #8f8f9d; list-style-type: none; margin: 0; padding: 0.3em; flex-grow: 1; overflow-x: hidden;";

        let current_table = table_select.value;
        let columns = tables_and_columns[current_table];

        let check_status = "";
        if (columns_list_value.value !== "") {
            check_status = JSON.parse(columns_list_value.value);
        }
        for (let i = 0; i < columns.length; i++) {
            check_box_list.appendChild(create_checkbox_for_list(columns[i].toString(), check_status.includes(columns[i].toString())));
            // dummy_field_value.appendChild(create_checkbox_for_list(i.toString()));
        }

        columns_list_value.parentNode.appendChild(check_box_list);
    }


    function write_checkbox_content_to_str_list() {
        // let check_box_list = document.getElementById("check_box_list");
        let result = [];
        //iterate through li elements
        for (let i = 0; i < check_box_list.children.length; i++) {
            // get checkbox element
            let checkbox_element = check_box_list.children[i].children[0].children[0];

            if (checkbox_element.checked) {
                result.push(checkbox_element.name);
            }
        }
        columns_list_value.value = JSON.stringify(result);
    }


    function init_table_name_value() {
        table_name_value.style.display = "none";
        let table_select = document.createElement("select");
        table_select.setAttribute("id", "table_select");
        table_select.setAttribute("class", "qhana-form-input");

        Object.keys(tables_and_columns).forEach(function (key) {
            let table_option = document.createElement("option")
            table_option.setAttribute("value", key);
            table_option.innerText = key.toString();
            if (key.toString() === table_name_value.value) {
                table_option.setAttribute("selected", "selected");
            }
            table_select.appendChild(table_option);
        });

        table_name_value.parentNode.appendChild(table_select);
        return table_select
    }


    function update_id_attribute_list() {
        let current_table = table_select.value;
        let columns = tables_and_columns[current_table];

        // replaceChildren with array of new children somehow didn't work
        id_attribute_list_value.replaceChildren();
        columns.forEach(col => {
            let c = document.createElement("option");
            c.value = col;
            id_attribute_list_value.appendChild(c);
        });
    }


    function table_select_change() {
        table_name_value.value = table_select.value;
        let check_all_box = document.getElementById("select all_box");
        check_all_box.checked = false;
        create_check_box_list();
        update_id_attribute_list();
    }


    function save_table_change() {
        attribute_to_id_vis.style.display = "none";
        if (save_table_value.checked === true) {
            attribute_to_id_vis.style.display = "block"
        }
    }


    columns_list_value.style.display = "none";
    attribute_to_id_value.setAttribute("list", "id_attribute_list");
    table_select = init_table_name_value();
    save_table_change();
    init_check_all_box();
    table_select_change();
    change_custom_query();


    let buttons = document.getElementsByClassName("qhana-form-buttons");
    buttons[0].addEventListener("click", write_checkbox_content_to_str_list, false);
    save_table_value.addEventListener("change", save_table_change);
    table_select.addEventListener("change", table_select_change);
    custom_query_value.addEventListener("change", change_custom_query);
</script>

<script>
    const test_button = document.getElementById("test_button");
    const qhana_form = document.getElementsByClassName("qhana-form")[0];

    function retrieve_parameters(form) {
        let inputs = {};
        form.querySelectorAll("input").forEach(item => {
            if (!item.id.endsWith("box")) {
                if (item.type === "checkbox") {
                    inputs[item.id] = item.checked;
                } else {
                    inputs[item.id] = item.value;
                }
            }
        });
        return inputs
    }

    function test_button_click() {
        let data = new URLSearchParams(retrieve_parameters(qhana_form));
        let target_url = new URL("{{ get_pd_html }}", window.location.href);
        console.log(`target_url: ${target_url}`);

        data.forEach((value, key) => {
            console.log(`${key}: ${value}`);
            target_url.searchParams.append(key, value);
        })

        fetch(target_url.toString())
            // fetch() returns a promise. When we have received a response from the server,
            // the promise's `then()` handler is called with the response.
            .then((response) => {
                // Our handler throws an error if the request did not succeed.
                if (!response.ok) {
                    throw new Error(`HTTP error: ${response.status}`);
                }
                // Otherwise (if the response succeeded), our handler fetches the response
                // as text by calling response.text(), and immediately returns the promise
                // returned by `response.text()`.
                return response.text();
            })
            // When response.text() has succeeded, the `then()` handler is called with
            // the text
            .then((text) => {
                console.log(text);
            })
            // Catch any errors that might happen
            .catch((error) => {
                console.log(`Could not fetch verse: ${error}`);
            });
    }

    test_button.addEventListener("click", test_button_click);
</script>

<script src="{{url_for('static', filename='microfrontend.js')}}"></script>
{% endblock script %}
