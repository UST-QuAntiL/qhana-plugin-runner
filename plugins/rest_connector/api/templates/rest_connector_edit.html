{% extends "simple_template.html" %}

{% block head %}
    {{ super() }}

    <style>
        [hidden] {
            display: none !important;
        }
        .content {
            max-width: 50rem;
            margin-inline: auto;
            padding: 1rem;
        }
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .step {
            --step-border-color: var(--border-color, black);
            --step-color: var(--background, white);
            --step-text-color: var(--text, black);
        }
        .step.done {
            --step-border-color: var(--primary, gray);
            --step-color: var(--primary, gray);
            --step-text-color: var(--text-primary, white);
        }
        .step[open] {
            --step-border-color: var(--primary, gray);
            --step-color: var(--background, white);
            --step-text-color: var(--text, black);
        }
        .step.done[open] {
            --step-text-color: var(--primary-text, black);
        }
        .step .step-head {
            cursor: pointer;
            display: inline-flex;
            align-items: baseline;
            text-wrap: nowrap;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .step .step-head > * {
            flex-shrink: 0;
        }
        .step-content-preview {
            flex-shrink: 1;
            opacity: 0.8;
            display: inline-block;
            margin-left: 1.5rem;
            text-overflow: ellipsis;
        }
        .step[open] > .step-head {
            background-color: var(--primary, dark-gray);
            color: var(--text-primary, black);
            border-radius: 0.3rem;
        }
        .step > .step-head::marker, .step > .step-head::-webkit-details-marker {
            display: none;
            content: "";
        }
        .step > .step-head::before {
            content: attr(data-stepnr);
            display: inline-flex;
            flex-shrink: 0;
            align-items: center;
            justify-content: center;
            width: 2rem;
            height: 2rem;
            margin-inline-start: 0.3rem;
            margin-inline-end: 1rem;
            margin-block: 0.3rem;
            background-color: var(--step-color, dark-gray);
            color: var(--step-text-color, white);
            border-radius: 100%;
            border: 1px solid;
            border-color: var(--step-border-color, black);
        }
        .step.done > .step-head::before {
            content: "✓";
        }
        .step[open] > :not(.step-head) {
            margin-block-start: 0.3rem;
            margin-inline-start: calc(1.3rem - 1px);
            padding-inline-start: calc(2rem - 1px);
            border-left: 2px solid;
            border-color: var(--step-border-color, dark-gray);
        }
    </style>
{% endblock head %}

{% block content %}

    <div class="content">
    <div class="header">
    <h3>{{name}} (WIP)</h3>
    <a href="{{back}}">back</a>
    </div>

    <!-- TODO expand list -->
    <datalist id="dataTypeList">
        <option value="entity/list"></option>
        <option value="executable/circuit"></option>
        <option value="custom/"></option>
    </datalist>

    <!-- TODO expand list -->
    <datalist id="contentTypeList">
        <option value="text/plain"></option>
        <option value="text/x-qasm"></option>
        <option value="application/json"></option>
        <option value="application/xml"></option>
    </datalist>


    {%- if connector['isLoading'] -%}
    <details class="step" open>
        <summary class="step-head" data-stepnr="⏳">Performing Background Work</summary>

        <form action="{{process}}" method="post" class="qhana-form" data-step="manage-plugin" enctype="application/json">
            <div class="qhana-form-buttons">
                <button class="qhana-form-submit" type="submit" data-target="api" name="command" value="cancel">cancel background task</button>
            </div>
        </form>
    </details>
    {%- endif -%}

    <details class="step {{'done' if 'base-url' in connector['finishedSteps']}}" {{"open" if connector["nextStep"] == "base-url" or not connector["baseUrl"] else ""}}>
        <summary class="step-head" data-stepnr="1">
            API Base URL <span class="step-content-preview">{{connector["baseUrl"]}}</span>
        </summary>

        <form action="{{process}}" method="post" class="qhana-form" data-step="base-url" enctype="application/json" {{'inert' if connector['isLoading']}}>
            <div class="qhana-form-field">
                <label class="qhana-form-label" for="value">REST API URL</label>
                <div class="qhana-input-wrapper">
                    <input class="qhana-form-input" type="url" name="value" id="base_url" autocomplete="off" value="{{connector['baseUrl']}}" {{'disabled' if connector['isLoading']}}>
                </div>
            </div>

            <div class="qhana-form-buttons">
                <button class="qhana-form-submit" type="submit" data-target="api" {{'disabled' if connector['isLoading']}}>set API base URL</button>
            </div>
        </form>
    </details>

    <details class="step {{'done' if 'openapi-spec' in connector['finishedSteps']}}" {{"open" if connector["nextStep"] == "openapi-spec" else ""}}>
        <summary class="step-head" data-stepnr="2">
            OpenAPI Spec URL <span class="step-content-preview">{{connector["openapiSpecUrl"]}}</span>
        </summary>

        <form action="{{process}}" method="post" class="qhana-form" data-step="openapi-spec" enctype="application/json" {{'inert' if connector['isLoading']}}>
            <div class="qhana-form-field">
                <label class="qhana-form-label" for="value">OpenAPI spec URL</label>
                <div class="qhana-input-wrapper">
                    <input class="qhana-form-input" type="text" name="value" id="openapi_spec_url" autocomplete="off" value="{{connector['openapiSpecUrl']}}" {{'disabled' if connector['isLoading']}}>
                </div>
            </div>

            <div class="qhana-form-buttons">
                <button class="qhana-form-submit" type="submit" data-target="api" {{'disabled' if connector['isLoading']}}>set OpenAPI spec URL</button>
            </div>
        </form>
    </details>

    <details class="step {{'done' if 'endpoint-url' in connector['finishedSteps']}}" {{"open" if connector["nextStep"] == "endpoint-url" else ""}}>
        <summary class="step-head" data-stepnr="3">
            Endpoint URL <span class="step-content-preview">{{connector["endpointUrl"]}}</span>
        </summary>

        <form action="{{process}}" method="post" class="qhana-form" data-step="endpoint-url" enctype="application/json" {{'inert' if connector['isLoading']}}>
            <div class="qhana-form-field">
                <label class="qhana-form-label" for="value">Endpoint URL</label>
                <div class="qhana-input-wrapper">
                    <input class="qhana-form-input" type="text" name="value" id="endpoint_url" list="endpoint_url_list" autocomplete="off" value="{{connector['endpointUrl']}}" {{'disabled' if connector['isLoading']}}>
                    <datalist id="endpoint_url_list">
                        {%- for path in autocomplete_paths -%}
                        <option value="{{path}}"></option>
                        {%- endfor -%}
                    </datalist>
                </div>
            </div>

            <div class="qhana-form-buttons">
                <button class="qhana-form-submit" type="submit" data-target="api" {{'disabled' if connector['isLoading']}}>set endpoint URL</button>
            </div>
        </form>
    </details>

    <!-- FIXME add support for variables in endpoint -->

    <details class="step {{'done' if 'endpoint-method' in connector['finishedSteps']}}" {{"open" if connector["nextStep"] == "endpoint-method" else ""}}>
        <summary class="step-head" data-stepnr="4">
            Endpoint method <span class="step-content-preview">{{connector["endpointMethod"]}}</span>
        </summary>

        <form action="{{process}}" method="post" class="qhana-form" data-step="endpoint-method" enctype="application/json" {{'inert' if connector['isLoading']}}>
            <div class="qhana-form-field">
                <label class="qhana-form-label" for="endpoint_method">Endpoint URL</label>
                <div class="qhana-input-wrapper">
                    <select class="qhana-form-input" name="value" id="endpoint_method" {{'disabled' if connector['isLoading']}}>
                        {% for method in http_methods if not autocomplete_methods or (method.lower() in autocomplete_methods) %}
                            <option value="{{ method }}" {% if connector['endpointMethod'] == method %} selected {% endif %}>{{ method }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="qhana-form-buttons">
                <button class="qhana-form-submit" type="submit" data-target="api" {{'disabled' if connector['isLoading']}}>set endpoint method</button>
            </div>
        </form>
    </details>

    <details class="step {{'done' if 'endpoint-variables' in connector['finishedSteps']}}" {{"open" if connector["nextStep"] == "endpoint-variables" else ""}}>
        <summary class="step-head" data-stepnr="5">
            Endpoint Variables <span class="step-content-preview" {{"hidden" if not connector["endpointVariables"]}}>[{{connector["endpointVariables"] | join(", ")}}]</span>
        </summary>

        <form action="{{process}}" method="post" class="qhana-form" data-step="endpoint-variables" data-value="json-object" enctype="application/json" {{'inert' if connector['isLoading']}}>
            <fieldset id="endpoint_variables" {{'disabled' if connector['isLoading']}}>
                <legend>Endpoint Variables</legend>
                {%- for var, value in connector['endpointVariables'].items() -%}
                <div class="qhana-form-field">
                    <label class="qhana-form-label" for="json__{{var}}">{{var}}</label>
                    <div class="qhana-input-wrapper">
                        <textarea class="qhana-form-input" name="json__{{var}}" autocomplete="off" >{{value}}</textarea>
                    </div>
                </div>
                {%- endfor -%}
            </fieldset>

            <div class="qhana-form-buttons">
                <button class="qhana-form-submit" type="submit" data-target="api" {{'disabled' if connector['isLoading']}}>set endpoint variables</button>
            </div>
        </form>
    </details>

    <details class="step {{'done' if 'endpoint-query-variables' in connector['finishedSteps']}}" {{"open" if connector["nextStep"] == "endpoint-query-variables" else ""}}>
        <summary class="step-head" data-stepnr="6">
            Endpoint Query Variables <span class="step-content-preview" {{"hidden" if not connector["endpointQueryVariables"]}}>[{{connector["endpointQueryVariables"] | join(", ")}}]</span>
        </summary>

        <form action="{{process}}" method="post" class="qhana-form" data-step="endpoint-query-variables" data-value="json-object" enctype="application/json" {{'inert' if connector['isLoading']}}>
            <fieldset id="endpoint_query_variables" {{'disabled' if connector['isLoading']}}>
                <legend>Endpoint Query Variables</legend>
                {%- for var, value in connector['endpointQueryVariables'].items() -%}
                <div class="qhana-form-field">
                    <label class="qhana-form-label" for="json__{{var}}">{{var}}</label>
                    <div class="qhana-input-wrapper">
                        <textarea class="qhana-form-input" name="json__{{var}}" autocomplete="off">{{value}}</textarea>
                        <button class="remove-object-key">remove query variable</button>
                    </div>
                </div>
                {%- endfor -%}
                <template id="new_endpoint_query_variable">
                    <div class="qhana-form-field">
                        <label class="qhana-form-label" for="json__"></label>
                        <div class="qhana-input-wrapper">
                            <textarea class="qhana-form-input" name="json__" autocomplete="off"></textarea>
                            <button class="remove-object-key">remove query variable</button>
                        </div>
                    </div>
                </template>
                <div class="qhana-form-field">
                    <label class="qhana-form-label" for="new_key">Variable Name</label>
                    <div class="qhana-input-wrapper">
                        <input class="qhana-form-input" name="new_key" autocomplete="off">
                        <button class="add-object-key" name="add_new_key" data-template="new_endpoint_query_variable">add query variable</button>
                    </div>
                </div>

            </fieldset>

            <div class="qhana-form-buttons">
                <button class="qhana-form-submit" type="submit" data-target="api" {{'disabled' if connector['isLoading']}}>set endpoint query variables</button>
            </div>
        </form>
    </details>

    <details class="step {{'done' if 'variables' in connector['finishedSteps']}}" {{"open" if connector["nextStep"] == "variables" else ""}}>
        <summary class="step-head" data-stepnr="7">
            Variables <span class="step-content-preview" {{"hidden" if not connector["variables"]}}>[{{connector["variables"] | join(", ", attribute="name")}}]</span>
        </summary>

        <form action="{{process}}" method="post" class="qhana-form" data-step="variables" data-value="json-array" enctype="application/json" {{'inert' if connector['isLoading']}}>
            {%- for variable in connector['variables'] -%}
            <fieldset class="object-container" id="{{loop.index}}__variables" {{'disabled' if connector['isLoading']}}>
                <legend>Variable</legend>
                <div class="object-fields">
                    <div class="qhana-form-field">
                        <label class="qhana-form-label" for="json__{{loop.index}}_name">Name</label>
                        <div class="qhana-input-wrapper">
                            <input class="qhana-form-input" name="json__{{loop.index}}_name" autocomplete="off" required value="{{variable['name']}}">
                        </div>
                    </div>
                    <div class="qhana-form-field">
                        <label class="qhana-form-label" for="json__{{loop.index}}_type">Type</label>
                        <div class="qhana-input-wrapper">
                            <select class="qhana-form-input" name="json__{{loop.index}}_type" required>
                                <option value="string" {{ "selected" if variable["type"] == "string" }}>String</option>
                                <option value="text" {{ "selected" if variable["type"] == "text" }}>Multiline text</option>
                                <option value="number" {{ "selected" if variable["type"] == "number" }}>Number</option>
                                <option value="integer" {{ "selected" if variable["type"] == "integer" }}>Integer</option>
                                <option value="data" {{ "selected" if variable["type"] == "data" }}>Data</option>
                            </select>
                        </div>
                    </div>
                    <div class="qhana-form-field">
                        <label class="qhana-form-label" for="json__{{loop.index}}_defaultValue">Default value</label>
                        <div class="qhana-input-wrapper">
                            <input class="qhana-form-input" name="json__{{loop.index}}_defaultValue" autocomplete="off" value="{{variable['defaultValue']}}">
                        </div>
                    </div>
                    <div class="qhana-form-field">
                        <label class="qhana-form-label" for="json__{{loop.index}}_title">Title</label>
                        <div class="qhana-input-wrapper">
                            <input class="qhana-form-input" name="json__{{loop.index}}_title" autocomplete="off" value="{{variable['title']}}">
                        </div>
                    </div>
                    <div class="qhana-form-field">
                        <label class="qhana-form-label" for="json__{{loop.index}}_description">Description</label>
                        <div class="qhana-input-wrapper">
                            <textarea class="qhana-form-input" name="json__{{loop.index}}_description" autocomplete="off">{{variable['description']}}</textarea>
                        </div>
                    </div>
                    <div class="qhana-form-field">
                        <label class="qhana-form-label" for="json__{{loop.index}}_required">Required</label>
                        <div class="qhana-input-wrapper">
                            <input class="qhana-form-input" type="checkbox" name="json__{{loop.index}}_required" {{'checked' if variable['required']}}>
                        </div>
                    </div>
                    <p>Fields for "data" variables:</p>
                    <div class="qhana-form-field">
                        <label class="qhana-form-label" for="json__{{loop.index}}_dataType">Data type</label>
                        <div class="qhana-input-wrapper">
                            <input class="qhana-form-input" name="json__{{loop.index}}_dataType" list="dataTypeList" autocomplete="off" value="{{variable['dataType']}}">
                        </div>
                    </div>
                    <div class="qhana-form-field">
                        <label class="qhana-form-label" for="json__{{loop.index}}_contentType">Content type</label>
                        <div class="qhana-input-wrapper">
                            <input class="qhana-form-input" name="json__{{loop.index}}_contentType" list="contentTypeList" autocomplete="off" value="{{variable['contentType']}}">
                        </div>
                    </div>
                    <div class="qhana-form-field">
                        <label class="qhana-form-label" for="json__{{loop.index}}_loadContent">Load data content into variable</label>
                        <div class="qhana-input-wrapper">
                            <input class="qhana-form-input" type="checkbox" name="json__{{loop.index}}_loadContent" {{'checked' if variable['loadContent']}}>
                        </div>
                    </div>
                </div>

                <div class="object-controls">
                    <button class="move-array-item-up">up</button>
                    <button class="remove-array-item">remove object</button>
                    <button class="move-array-item-down">down</button>
                </div>
            </fieldset>
            {%- endfor -%}
            <template id="new_variable">
                <fieldset class="object-container" id="SLUG__variables" {{'disabled' if connector['isLoading']}}>
                    <legend>Variable</legend>
                    <div class="object-fields">
                        <div class="qhana-form-field">
                            <label class="qhana-form-label" for="json__SLUG_name">Name</label>
                            <div class="qhana-input-wrapper">
                                <input class="qhana-form-input" name="json__SLUG_name" autocomplete="off" required>
                            </div>
                        </div>
                        <div class="qhana-form-field">
                            <label class="qhana-form-label" for="json__SLUG_type">Type</label>
                            <div class="qhana-input-wrapper">
                                <select class="qhana-form-input" name="json__SLUG_type" required>
                                    <option value="string">String</option>
                                    <option value="text">Multiline text</option>
                                    <option value="number">Number</option>
                                    <option value="integer">Integer</option>
                                    <option value="data">Data</option>
                                </select>
                            </div>
                        </div>
                        <div class="qhana-form-field">
                            <label class="qhana-form-label" for="json__SLUG_defaultValue">Default value</label>
                            <div class="qhana-input-wrapper">
                                <input class="qhana-form-input" name="json__SLUG_defaultValue" autocomplete="off">
                            </div>
                        </div>
                        <div class="qhana-form-field">
                            <label class="qhana-form-label" for="json__SLUG_title">Title</label>
                            <div class="qhana-input-wrapper">
                                <input class="qhana-form-input" name="json__SLUG_title" autocomplete="off">
                            </div>
                        </div>
                        <div class="qhana-form-field">
                            <label class="qhana-form-label" for="json__SLUG_description">Description</label>
                            <div class="qhana-input-wrapper">
                                <textarea class="qhana-form-input" name="json__SLUG_description" autocomplete="off"></textarea>
                            </div>
                        </div>
                        <div class="qhana-form-field">
                            <label class="qhana-form-label" for="json__SLUG_required">Required</label>
                            <div class="qhana-input-wrapper">
                                <input class="qhana-form-input" type="checkbox" name="json__SLUG_required">
                            </div>
                        </div>
                        <p>Fields for "data" variables:</p>
                        <div class="qhana-form-field">
                            <label class="qhana-form-label" for="json__SLUG_dataType">Data type</label>
                            <div class="qhana-input-wrapper">
                                <input class="qhana-form-input" name="json__SLUG_dataType" list="dataTypeList" autocomplete="off">
                            </div>
                        </div>
                        <div class="qhana-form-field">
                            <label class="qhana-form-label" for="json__SLUG_contentType">Content type</label>
                            <div class="qhana-input-wrapper">
                                <input class="qhana-form-input" name="json__SLUG_contentType" list="contentTypeList" autocomplete="off">
                            </div>
                        </div>
                        <div class="qhana-form-field">
                            <label class="qhana-form-label" for="json__SLUG_loadContent">Load data content into variable</label>
                            <div class="qhana-input-wrapper">
                                <input class="qhana-form-input" type="checkbox" name="json__SLUG_loadContent">
                            </div>
                        </div>
                    </div>

                    <div class="object-controls">
                        <button class="move-array-item-up">up</button>
                        <button class="remove-array-item">remove object</button>
                        <button class="move-array-item-down">down</button>
                    </div>
                </fieldset>
            </template>
            <button class="add-array-item" name="add_new_object" data-template="new_variable">add variable</button>

            <div class="qhana-form-buttons">
                <button class="qhana-form-submit" type="submit" data-target="api" {{'disabled' if connector['isLoading']}}>set variables</button>
            </div>
        </form>
    </details>

    <details class="step {{'done' if 'request-headers' in connector['finishedSteps']}}" {{"open" if connector["nextStep"] == "request-headers" else ""}}>
        <summary class="step-head" data-stepnr="8">
            Request Headers <span class="step-content-preview" {{"hidden" if not connector["requestHeaders"]}}>{{connector["requestHeaders"].splitlines()[:5] | join(" | ")}}</span>
        </summary>

        <form action="{{process}}" method="post" class="qhana-form" data-step="request-headers" enctype="application/json" {{'inert' if connector['isLoading']}}>
            <div class="qhana-form-field">
                <label class="qhana-form-label" for="value">Request headers</label>
                <div class="qhana-input-wrapper">
                    <textarea class="qhana-form-input" name="value" id="request_headers" autocomplete="off" {{'disabled' if connector['isLoading']}}>{{connector['requestHeaders']}}</textarea>
                </div>
            </div>

            <div class="qhana-form-buttons">
                <button class="qhana-form-submit" type="submit" data-target="api" {{'disabled' if connector['isLoading']}}>set request headers</button>
            </div>
        </form>
    </details>

    <details class="step {{'done' if 'request-body' in connector['finishedSteps']}}" {{"open" if connector["nextStep"] == "request-body" else ""}}>
        <summary class="step-head" data-stepnr="9">
            Request Body <span class="step-content-preview">{{connector["requestBody"].splitlines()[:10] | join(" ")}}</span>
        </summary>

        <form action="{{process}}" method="post" class="qhana-form" data-step="request-body" enctype="application/json" {{'inert' if connector['isLoading']}}>
            <div class="qhana-form-field">
                <label class="qhana-form-label" for="value">Request body</label>
                <div class="qhana-input-wrapper">
                    <textarea class="qhana-form-input" name="value" id="request_body" autocomplete="off" {{'disabled' if connector['isLoading']}}>{{connector['requestBody']}}</textarea>
                </div>
            </div>

            <div class="qhana-form-buttons">
                <button class="qhana-form-submit" type="submit" data-target="api" {{'disabled' if connector['isLoading']}}>set request body</button>
            </div>
        </form>
    </details>

    <details class="step {{'done' if 'request-files' in connector['finishedSteps']}}" {{"open" if connector["nextStep"] == "request-files" else ""}}>
        <summary class="step-head" data-stepnr="10">
            Request Files <span class="step-content-preview" {{"hidden" if not connector["requestFiles"]}}>{{connector["requestFiles"]|length}} input file(s)</span>
        </summary>

        <form action="{{process}}" method="post" class="qhana-form" data-step="request-files" data-value="json-array" enctype="application/json" {{'inert' if connector['isLoading']}}>
            {%- for file in connector['requestFiles'] -%}
            <fieldset class="object-container" id="{{loop.index}}__request_files" {{'disabled' if connector['isLoading']}}>
                <legend>Request files</legend>
                <div class="object-fields">
                    <div class="qhana-form-field">
                        <label class="qhana-form-label" for="json__{{loop.index}}_formFieldName">Form field name</label>
                        <div class="qhana-input-wrapper">
                            <input class="qhana-form-input" name="json__{{loop.index}}_formFieldName" autocomplete="off" value="{{file['formFieldName']}}">
                        </div>
                    </div>
                    <div class="qhana-form-field">
                        <label class="qhana-form-label" for="json__{{loop.index}}_contentType">Content type</label>
                        <div class="qhana-input-wrapper">
                            <input class="qhana-form-input" name="json__{{loop.index}}_contentType" list="contentTypeList" autocomplete="off" value="{{file['contentType']}}">
                        </div>
                    </div>
                    <div class="qhana-form-field">
                        <label class="qhana-form-label" for="json__{{loop.index}}_data">Data</label>
                        <div class="qhana-input-wrapper">
                            <textarea class="qhana-form-input" name="json__{{loop.index}}_data" autocomplete="off" required>{{file['data']}}</textarea>
                        </div>
                    </div>
                    <div class="qhana-form-field">
                        <label class="qhana-form-label" for="json__{{loop.index}}_dereferenceUrl">Dereference URL in data</label>
                        <div class="qhana-input-wrapper">
                            <input class="qhana-form-input" type="checkbox" name="json__{{loop.index}}_dereferenceUrl" {{'checked' if file['dereferenceUrl']}}>
                        </div>
                    </div>
                </div>

                <div class="object-controls">
                    <button class="move-array-item-up">up</button>
                    <button class="remove-array-item">remove object</button>
                    <button class="move-array-item-down">down</button>
                </div>
            </fieldset>
            {%- endfor -%}
            <template id="new_request_file">
                <fieldset class="object-container" id="SLUG__request_files" {{'disabled' if connector['isLoading']}}>
                    <legend>Request files</legend>
                    <div class="object-fields">
                        <div class="qhana-form-field">
                            <label class="qhana-form-label" for="json__SLUG_formFieldName">Form field name</label>
                            <div class="qhana-input-wrapper">
                                <input class="qhana-form-input" name="json__SLUG_formFieldName" autocomplete="off">
                            </div>
                        </div>
                        <div class="qhana-form-field">
                            <label class="qhana-form-label" for="json__SLUG_contentType">Content type</label>
                            <div class="qhana-input-wrapper">
                                <input class="qhana-form-input" name="json__SLUG_contentType" list="contentTypeList" autocomplete="off">
                            </div>
                        </div>
                        <div class="qhana-form-field">
                            <label class="qhana-form-label" for="json__SLUG_data">Data</label>
                            <div class="qhana-input-wrapper">
                                <textarea class="qhana-form-input" name="json__SLUG_data" autocomplete="off" required></textarea>
                            </div>
                        </div>
                        <div class="qhana-form-field">
                            <label class="qhana-form-label" for="json__SLUG_dereferenceUrl">Dereference URL in data</label>
                            <div class="qhana-input-wrapper">
                                <input class="qhana-form-input" type="checkbox" name="json__SLUG_dereferenceUrl">
                            </div>
                        </div>
                    </div>

                    <div class="object-controls">
                        <button class="move-array-item-up">up</button>
                        <button class="remove-array-item">remove object</button>
                        <button class="move-array-item-down">down</button>
                    </div>
                </fieldset>
            </template>
            <button class="add-array-item" name="add_new_object" data-template="new_request_file">add request file</button>

            <div class="qhana-form-buttons">
                <button class="qhana-form-submit" type="submit" data-target="api" {{'disabled' if connector['isLoading']}}>set request files</button>
            </div>
        </form>
    </details>

    <details class="step {{'done' if 'response-handling' in connector['finishedSteps']}}" {{"open" if connector["nextStep"] == "response-handling" else ""}}>
        <summary class="step-head" data-stepnr="11">
            Response Handling <span class="step-content-preview">{{connector["responseHandling"]}}</span>
        </summary>

        <form action="{{process}}" method="post" class="qhana-form" data-step="response-handling" enctype="application/json" {{'inert' if connector['isLoading']}}>
            <div class="qhana-form-field">
                <label class="qhana-form-label" for="value">Response handling strategy</label>
                <div class="qhana-input-wrapper">
                    <input class="qhana-form-input" type="text" name="value" id="response_handling" autocomplete="off" list="response-handling-types" value="{{connector['responseHandling']}}" {{'disabled' if connector['isLoading']}}>
                    <datalist id="response-handling-types">
                        <option value="default"></option>
                    </datalist>
                </div>
            </div>

            <div class="qhana-form-buttons">
                <button class="qhana-form-submit" type="submit" data-target="api" {{'disabled' if connector['isLoading']}}>set endpoint URL</button>
            </div>
        </form>
    </details>

    <details class="step {{'done' if 'response-mapping' in connector['finishedSteps']}}" {{"open" if connector["nextStep"] == "response-mapping" else ""}}>
        <summary class="step-head" data-stepnr="12">
            Response Mapping <span class="step-content-preview" {{"hidden" if not connector["responseMapping"]}}>[{{connector["responseMapping"] | join(", ", attribute="name")}}]</span>
        </summary>

        <form action="{{process}}" method="post" class="qhana-form" data-step="response-mapping" data-value="json-array" enctype="application/json" {{'inert' if connector['isLoading']}}>
            {%- for map in connector['responseMapping'] -%}
            <fieldset class="object-container" id="{{loop.index}}__response_map" {{'disabled' if connector['isLoading']}}>
                <legend>Response Map</legend>
                <div class="object-fields">
                    <div class="qhana-form-field">
                        <label class="qhana-form-label" for="json__{{loop.index}}_name">Name</label>
                        <div class="qhana-input-wrapper">
                            <input class="qhana-form-input" name="json__{{loop.index}}_name" autocomplete="off" required value="{{map['name']}}">
                        </div>
                    </div>
                    <div class="qhana-form-field">
                        <label class="qhana-form-label" for="json__{{loop.index}}_dataType">Data type</label>
                        <div class="qhana-input-wrapper">
                            <input class="qhana-form-input" name="json__{{loop.index}}_dataType" list="dataTypeList" autocomplete="off" required value="{{map['dataType']}}">
                        </div>
                    </div>
                    <div class="qhana-form-field">
                        <label class="qhana-form-label" for="json__{{loop.index}}_contentType">Content type</label>
                        <div class="qhana-input-wrapper">
                            <input class="qhana-form-input" name="json__{{loop.index}}_contentType" list="contentTypeList" autocomplete="off" required value="{{map['contentType']}}">
                        </div>
                    </div>
                    <div class="qhana-form-field">
                        <label class="qhana-form-label" for="json__{{loop.index}}_data">Data</label>
                        <div class="qhana-input-wrapper">
                            <textarea class="qhana-form-input" name="json__{{loop.index}}_data" autocomplete="off" required>{{map['data']}}</textarea>
                        </div>
                    </div>
                    <div class="qhana-form-field">
                        <label class="qhana-form-label" for="json__{{loop.index}}_dereferenceUrl">Dereference URL in data</label>
                        <div class="qhana-input-wrapper">
                            <input class="qhana-form-input" type="checkbox" name="json__{{loop.index}}_dereferenceUrl" {{'checked' if map['dereferenceUrl']}}>
                        </div>
                    </div>
                </div>

                <div class="object-controls">
                    <button class="move-array-item-up">up</button>
                    <button class="remove-array-item">remove object</button>
                    <button class="move-array-item-down">down</button>
                </div>
            </fieldset>
            {%- endfor -%}
            <template id="new_response_mapping">
                <fieldset class="object-container" id="SLUG__response_map" {{'disabled' if connector['isLoading']}}>
                    <legend>Response Map</legend>
                    <div class="object-fields">
                        <div class="qhana-form-field">
                            <label class="qhana-form-label" for="json__SLUG_name">Name</label>
                            <div class="qhana-input-wrapper">
                                <input class="qhana-form-input" name="json__SLUG_name" autocomplete="off" required>
                            </div>
                        </div>
                        <div class="qhana-form-field">
                            <label class="qhana-form-label" for="json__SLUG_dataType">Data type</label>
                            <div class="qhana-input-wrapper">
                                <input class="qhana-form-input" name="json__SLUG_dataType" list="dataTypeList" autocomplete="off" required>
                            </div>
                        </div>
                        <div class="qhana-form-field">
                            <label class="qhana-form-label" for="json__SLUG_contentType">Content type</label>
                            <div class="qhana-input-wrapper">
                                <input class="qhana-form-input" name="json__SLUG_contentType" list="contentTypeList" autocomplete="off" required>
                            </div>
                        </div>
                        <div class="qhana-form-field">
                            <label class="qhana-form-label" for="json__SLUG_data">Data</label>
                            <div class="qhana-input-wrapper">
                                <textarea class="qhana-form-input" name="json__SLUG_data" autocomplete="off" required></textarea>
                            </div>
                        </div>
                        <div class="qhana-form-field">
                            <label class="qhana-form-label" for="json__SLUG_dereferenceUrl">Dereference URL in data</label>
                            <div class="qhana-input-wrapper">
                                <input class="qhana-form-input" type="checkbox" name="json__SLUG_dereferenceUrl">
                            </div>
                        </div>
                    </div>

                    <div class="object-controls">
                        <button class="move-array-item-up">up</button>
                        <button class="remove-array-item">remove object</button>
                        <button class="move-array-item-down">down</button>
                    </div>
                </fieldset>
            </template>
            <button class="add-array-item" name="add_new_object" data-template="new_response_mapping">add response mapping</button>

            <div class="qhana-form-buttons">
                <button class="qhana-form-submit" type="submit" data-target="api" {{'disabled' if connector['isLoading']}}>set response mapping</button>
            </div>
        </form>
    </details>

    <details class="step" {{"open" if connector["nextStep"] == "manage-plugin" or connector.get("isDeployed", False) else ""}}>
        <summary class="step-head" data-stepnr="⚐">
            Manage Plugin <span class="step-content-preview" {{"hidden" if not (connector.get("isDeployed") or connector.get("isLoading"))}}>{{'loading' if connector['isLoading']}}{{'deployed' if connector['isDeployed']}}</span>
        </summary>

        <form action="{{process}}" method="post" class="qhana-form" data-step="manage-plugin" enctype="application/json" {{'inert' if connector['isLoading']}}>
            <div class="qhana-form-buttons">
                {%- if connector.get("isDeployed", False) %}
                <button class="qhana-form-submit" type="submit" data-target="api" name="command" value="undeploy" {{'disabled' if connector['isLoading']}}>undeploy plugin</button>
                {%- else %}
                <button class="qhana-form-submit" type="submit" data-target="api" name="command" value="deploy" {{'disabled' if connector['isLoading']}}>deploy plugin</button>
                {%- endif %}
                {%- if connector.get("isLoading", False) %}
                <button class="qhana-form-submit" type="submit" data-target="api" name="command" value="cancel">cancel background task</button>
                {%- endif %}
            </div>
        </form>
    </details>
    </div>

    <!--pre>{{connector | tojson(indent="    ")}}</pre-->
{% endblock content %}

{% block script %}
    {{ super() }}

    <script>
        const NEXT_STEP = {
            "base-url": "openapi-spec",
            "openapi-spec": "endpoint-url",
            "endpoint-url": "endpoint-method",
            "endpoint-method": "endpoint-variables",
            "endpoint-variables": "endpoint-query-variables",
            "endpoint-query-variables": "variables",
            "variables": "request-headers",
            "request-headers": "request-body",
            "request-body": "request-files",
            "request-files": "response-handling",
            "response-handling": "response-mapping",
            "response-mapping": "manage-plugin",
            "manage-plugin": "manage-plugin",
        };

        const isLoading = {{'true' if connector['isLoading'] else 'false'}};

        /**
        * @param {SubmitEvent} event
        */
        function submitStepForm(event, dataInputs, privateInputs) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            let formKey = form.getAttribute("data-step");
            const nextStep = NEXT_STEP[formKey];
            let formValue = formData.get("value") ?? "";

            if (form.getAttribute("data-value") === "json-object") {
                const jsonData = {};
                formData.forEach((value, key) => {
                    if (key.startsWith("json__")) {
                        jsonData[key.substring(6)] = value;
                    }
                });
                formValue = JSON.stringify(jsonData);
            }

            if (form.getAttribute("data-value") === "json-array") {
                const objects = form.querySelectorAll(".object-container");
                const jsonData = [];
                objects.forEach(container => {
                    const containerId = container.getAttribute("id")?.split("_", 1)?.[0] ?? "";
                    const objectKeyPrefix = `json__${containerId}_`;
                    const jsonObject = {};
                    formData.forEach((value, key) => {
                        if (!key.startsWith(objectKeyPrefix) || value === "") {
                            return;
                        }
                        const objectKey = key.replace(objectKeyPrefix, "");

                        if (Number.isFinite(Number(value))) {
                            value = Number(value);
                        } else if (value.startsWith('"') && value.endsWith('"') && Number.isFinite(Number(value.substring(1, value.length-1)))) {
                            // allow numbers escaped by "" to be normal strings
                            value = substring(1,-1);
                        }

                        const checkbox = form.querySelector(`input[type="checkbox"][name="${key}"]`);
                        if (checkbox) {
                            jsonObject[objectKey] = checkbox.checked;
                        } else {
                            jsonObject[objectKey] = value;
                        }
                    });
                    jsonData.push(jsonObject);
                });
                formValue = JSON.stringify(jsonData);
            }

            if (formKey === "manage-plugin") {
                formKey = event.submitter.getAttribute("value");
                if (!formKey) {
                    return; // was not submitted by a button, ignore
                }
            }
        
            const submitData = {
                key: formKey,
                value: formValue,
            };

            if (nextStep) {
                submitData.nextStep = nextStep;
            }

            sendMessage("ui-loading");

            fetch(form.getAttribute("action"), {
                body: JSON.stringify(submitData),
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "accept": "application/json",
                },
            }).then(response => {
                if (response.status === 200) {
                    // everything is good, reload UI to get new data
                    window.location.reload();
                    return;
                }
                response.json().then((jsonBody) => {
                    sendMessage({
                        type: "form-error",
                        status: response.status,
                        error: jsonBody,
                    }, (error) => {
                        sendMessage({
                            type: "form-error",
                            status: response.status,
                            error: "unknown error",
                        });
                    });
                });
            }, err => {
                sendMessage({
                    type: "form-error",
                    status: 500,
                    error: "unknown error",
                });
            });
        }

        function testLoadingStatus() {
            fetch("{{process}}", {
                headers: {
                    "Content-Type": "application/json",
                    "accept": "application/json",
                },
            }).then(response => {
                if (response.status === 200) {
                    response.json().then((jsonBody) => {
                        if (!jsonBody.isLoading) {
                            // background task finished, reload UI to get new data
                            window.location.reload();
                        }
                    });
                    return;
                }
            });
        }

        function addObjectKey(event) {
            event.preventDefault();
            const button = event.target;
            const form = button.form;
            const formData = new FormData(form);

            const templateId = button.getAttribute("data-template");
            const template = form.querySelector(`#${templateId}`);
            const objectKey = formData.get("new_key");
            if (!template || !objectKey) {
                return;
            }
            if (form.querySelector(`[name=json__${objectKey}]`) != null) {
                return; // key already exists
            }
            const cloned = template.content.cloneNode(true);
            cloned.querySelectorAll("[name=json__]").forEach(element => element.setAttribute("name", `json__${objectKey}`));
            cloned.querySelectorAll("[for=json__]").forEach(element => {
                element.setAttribute("for", `json__${objectKey}`);
                element.textContent = objectKey;
            });
            cloned.querySelectorAll("button.remove-object-key").forEach(button=>{
                button.addEventListener("click", removeObjectKey);
            });

            template.parentNode.insertBefore(cloned, template);
        }

        function removeObjectKey(event) {
            event.preventDefault();
            let target = event.target;
            while (target != null && !target.classList.contains("qhana-form-field")) {
                target = target.parentNode;
            }
            if (target != null) {
                target.remove();
            }
        }

        function addArrayItem(event) {
            event.preventDefault();
            const button = event.target;
            const form = button.form;

            const templateId = button.getAttribute("data-template");
            const template = form.querySelector(`#${templateId}`);
            if (!template) {
                return;
            }
            const slug = ("00000000" + Math.random().toString(36)).slice(-8);
            const cloned = template.content.cloneNode(true);
            cloned.querySelectorAll(".object-container[id]").forEach(element => {
                const attr = element.getAttribute("id");
                if (attr.startsWith("SLUG__")) {
                    element.setAttribute("id", `${slug}__${attr.substring(6)}`);
                }
            });
            cloned.querySelectorAll("[name]").forEach(element => {
                const attr = element.getAttribute("name");
                if (attr.startsWith("json__SLUG")) {
                    element.setAttribute("name", `json__${slug}${attr.substring(10)}`);
                }
            });
            cloned.querySelectorAll("[for]").forEach(element => {
                const attr = element.getAttribute("for");
                if (attr.startsWith("json__SLUG")) {
                    element.setAttribute("for", `json__${slug}${attr.substring(10)}`);
                }
            });
            cloned.querySelectorAll("button.remove-array-item").forEach(button=>{
                button.addEventListener("click", removeArrayItem);
            });
            cloned.querySelectorAll("button.move-array-item-up, button.move-array-item-down").forEach(button=>{
                button.addEventListener("click", moveArrayItem);
            });

            template.parentNode.insertBefore(cloned, template);
        }

        function removeArrayItem(event) {
            event.preventDefault();
            let target = event.target;
            while (target != null && !target.classList.contains("object-container")) {
                target = target.parentNode;
            }
            if (target != null) {
                target.remove();
            }
        }

        function moveArrayItem(event) {
            event.preventDefault();
            let target = event.target;
            const moveUp = target.classList.contains("move-array-item-up");
            const moveDown = target.classList.contains("move-array-item-down");
            while (target != null && !target.classList.contains("object-container")) {
                target = target.parentNode;
            }
            if (target != null) {
                if (moveUp && !(target.parentNode.children[0] === target)) {
                    target.previousElementSibling.before(target);
                } else if (moveDown && target.nextElementSibling.classList.contains("object-container")) {
                    target.nextElementSibling.after(target);
                }
            }
        }

        document.querySelectorAll("button.add-object-key").forEach(button=>{
            button.addEventListener("click", addObjectKey);
        });
        document.querySelectorAll("button.remove-object-key").forEach(button=>{
            button.addEventListener("click", removeObjectKey);
        });
        document.querySelectorAll("button.add-array-item").forEach(button=>{
            button.addEventListener("click", addArrayItem);
        });
        document.querySelectorAll("button.remove-array-item").forEach(button=>{
            button.addEventListener("click", removeArrayItem);
        });
        document.querySelectorAll("button.move-array-item-up, button.move-array-item-down").forEach(button=>{
            button.addEventListener("click", moveArrayItem);
        });

        if (!window._qhana_microfrontend_state) {
            window._qhana_microfrontend_state = {};
            instrumentForm();
        }
        window._qhana_microfrontend_state.formSubmitHandler = (event, dataInputs, privateInputs) => {
            submitStepForm(event, dataInputs, privateInputs);
            return true;
        }
        if (isLoading) {
            window.setInterval(testLoadingStatus, 2000);
        }
    </script>

{% endblock script %}
